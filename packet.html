<h2><a href="srlog2.html">srlog2</a></h2>

<h1>Packet Format</h1>

<h2>General Notes</h2>

<ul>

<li>A check code (CRC-32) is included inside the encrypted data on MSG
packets to ensure that the encryption state is properly synchronized on
client and server.</li>

<li>A 32-bit CRC takes no longer than a 16-bit CRC to calculate on
modern (32-bit) CPUs, perhaps even shorter due to using native word
size.  The difference in resulting packet size is negligable.</li>

<li>Hard coded to use HMAC-MD5, nistp224 keys, and AES-CBC with a
256-bit key for encryption and ESSIV, with the first 32 bytes of the
SHA512 hash of the nistp224 shared secret used for the key.
Additionally, the first 32 bytes of the SHA512 hash of the previous
SHA512 hash is used as the ESSIV encryptor.</li>

<li>A "timestamp" is encoded as a 4-byte unsigned number of seconds
since the UNIX epoch, and a 4-byte unsigned nanosecond offset.</li>

<li>All integers are unsigned.</li>

<li>Numbers are encoded in LSB format.</li>

<li>Strings are represented with a 1 or 2 byte length number (encoded as
above) followed by the raw data.  No trailing NUL byte is used.</li>

<li>Timestamps are composed of a 4-byte integer counting seconds since
the UNIX epoch, followed by a 4-byte integer counting the number of
nanoseconds since the last whole second.  Using unsigned integers, this
will be adequate until the year 2106.</li>

</ul>

<h2>Key Exchange</h2>

<p>The shared secret for the various packets is computed as follows:</p>

<table border=1 cellspacing=0 cellpadding=3>

<tr> <th>Packet</th> <th>Client Computes</th> <th>Server Computes</th>
</tr>

<tr> <td>INI</td> <td>Client secret * Server public</td>
<td>Server secret * Client public</td> </tr>

<tr> <td>CID</td> <td>Client session secret * Server public</td>
<td>Server secret * Client session public</td> </tr>

<tr> <td>ACK<br>or<br>MSG</td> <td>Client session secret * Server
session public</td> <td>Server session secret * Client session
public</td> </tr>

</table>

<h2>INI: Initialization Packet</h2>

<table cellspacing="0" border="1" cellpadding="3">

<tr> <th>Size</th> <th>Type</th> <th>Description</th> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Packet type "SRL2"</td> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Message type "INI1"</td> </tr>

<tr> <td>8</td> <td>Unsigned</td> <td>Initial Sequence number</td> </tr>

<tr> <td>8</td> <td>timestamp</td> <td>Initial timestamp</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Sender name</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Service name</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Authenticator name</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Key exchange name</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Key hash name</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Encryptor name</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Compressor name</td> </tr>

<tr> <td>28</td> <td>nistp224</td> <td>Client session public key</td>
</tr>

<tr> <td>16</td> <td>MD5</td> <td>Authenticator</td> </tr>

</table>

<h2>CID: Initialization Response Packet</h2>

<table cellspacing="0" border="1" cellpadding="3">

<tr> <th>Size</th> <th>Type</th> <th>Description</th> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Packet type "SRL2"</td> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Message type "CID1"</td> </tr>


<tr> <td>28</td> <td>nistp224</td> <td>Server session public key</td>
</tr>

<tr> <td>16</td> <td>MD5</td> <td>Authenticator</td> </tr>

</table>

<h2>MSG: Message Packet</h2>

<table cellspacing="0" border="1" cellpadding="3">

<tr> <th>Size</th> <th>Type</th> <th>Description</th> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Packet type "SRL2"</td> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Message type "MSG1"</td> </tr>

<tr> <td>8</td> <td>Unsigned</td> <td>Initial sequence number</td> </tr>

<tr> <td>1</td> <td>Unsigned</td> <td>Message count M</td> </tr>

<tr> <td>8</td> <td>timestamp</td> <td>Timestamp</td><td align="center"
rowspan="2">Repeated M times</td> <td align="center"
rowspan="4">Encrypted</td> </tr>

<tr> <td>2+N</td> <td>String</td> <td>Line</td> </tr>

<tr> <td>4</td> <td>CRC-32</td> <td>Check code on encrypted data</td>
</tr>

<tr> <td>?</td> <td>Char</td> <td>Padding to fill out encryption block
size</td> </tr>

<tr> <td>16</td> <td>MD5</td> <td>Authenticator</td> </tr>

</table>

<ul>

<li>The sequence number and message count are explicitly <i>not</i> in
the encrypted section, since an attacker can trivially determine them
from the returning ACK packets.

<li>The ACK to a MSG packet uses the sequence number of the last line
in the packet.</li>

<li>The length of padding is: P=B-(2+8+N+4)%B where B is the block size
of the cipher algorithm.  It will be at least one byte, and at most the
encryption block size.</li>

</ul>

<h2>ACK: Message Acknowledgement Packet</h2>

<table cellspacing="0" border="1" cellpadding="3">

<tr> <th>Size</th> <th>Type</th> <th>Description</th> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Packet type "SRL2"</td> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Message type "ACK1"</td> </tr>

<tr> <td>8</td> <td>Unsigned</td> <td>Sequence number</td> </tr>

<tr> <td>16</td> <td>MD5</td> <td>Authenticator</td> </tr>

</table>

<h2>SRQ: Status Request</h2>

<table cellspacing="0" border="1" cellpadding="3">

<tr> <th>Size</th> <th>Type</th> <th>Description</th> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Packet type "SRL2"</td> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Message type "SRQ1"</td> </tr>

<tr> <td>8</td> <td>String</td> <td>Nonce</td> </tr>

</table>

<h2>SRP: Status Response</h2>

<table cellspacing="0" border="1" cellpadding="3">

<tr> <th>Size</th> <th>Type</th> <th>Description</th> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Packet type "SRL2"</td> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Message type "SRP1"</td> </tr>

<tr> <td>8</td> <td>String</td> <td>Copy of nonce</td> </tr>

<tr> <td>2+N</td> <td>String</td> <td>Text status report</td> </tr>

</table>

<h2>PRQ: Preferences Query</h2>

<table cellspacing="0" border="1" cellpadding="3">

<tr> <th>Size</th> <th>Type</th> <th>Description</th> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Packet type "SRL2"</td> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Message type "PRQ1"</td> </tr>

<tr> <td>8</td> <td>String</td> <td>Nonce</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Authenticator list
("HMAC-MD5")</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Key exchange list
("nistp224")</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Key hash list ("SHA512")</td>
</tr>

<tr> <td>1+N</td> <td>String</td> <td>Encryptor list ("AES-CBC-ESSID")</td>
</tr>

<tr> <td>1+N</td> <td>String</td> <td>Compressor list ("null")</td>
</tr>

</table>

<ul>

<li>Multiple items in a list are separated byte the NUL byte.</li>

</ul>

<h2>PRF: Preferences Response</h2>

<table cellspacing="0" border="1" cellpadding="3">

<tr> <th>Size</th> <th>Type</th> <th>Description</th> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Packet type "SRL2"</td> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Message type "PRF1"</td> </tr>

<tr> <td>8</td> <td>String</td> <td>Copy of nonce</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Authenticator choice</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Key exchange choice</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Key hash choice</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Encryptor choice</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Compressor choice</td> </tr>

</table>

