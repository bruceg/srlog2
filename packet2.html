<h2><a href="srlog.html">srlog</a></h2>

<h1>Packet Format (Version 2)</h1>

<p>Version 2 of the packet format attempts to correct the following
defects:

<ul>

<li> Handling multiple messages in a single packet is awkward at
best.</li>

<li> Using MSB format requires byte swapping on the most common
architecture (ia32 aka i386).</li>

<li> Handling roaming senders is not possible.</li>

</ul>

<h2>General Notes</h2>

<ul>

<li>All integers are unsigned.

<li>Integers are represented in the given number of bytes in LSB
format.  That is, the low order byte is the first of the bytes.

<li>Strings are prefixed by either one or two length bytes.

<li>Timestamps are composed of a 4-byte integer counting seconds since
the UNIX epoch, followed by a 4-byte integer counting the number of
nanoseconds since the last whole second.

<li> Hard coded to use MD5 authenticators, nistp224 keys, and
AES-CBC for encryption.

<li>The secret for the authenticator as well as the authentication key
is the SHA256 hash of a key product as follows:

<table border=1 cellspacing=0 cellpadding=3>

<tr> <td rowspan=2>INI</td> <td>SHA256(Client secret * Server
public)</td> </tr>

<tr> <td>SHA256(Server secret * Client public)</td> </tr>

<tr> <td rowspan=2>CID</td> <td>SHA256(Client session secret * Server
public)</td> </tr>

<tr> <td>SHA256(Server secret * Client session public)</td> </tr>

<tr> <td rowspan=2>ACK<br>or<br>MSG</td> <td>SHA256(Client session
secret * Server session public)</td> </tr>

<tr> <td>SHA256(Server session secret * Client session public)</td>
</tr>

</table>

</ul>

<h2>INI: Initialization Packet</h2>

<table cellspacing="0" border="1" cellpadding="3">

<tr> <th>Size</th> <th>Type</th> <th>Description</th> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Packet type "SRL2"</td> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Message type "INIT"</td> </tr>

<tr> <td>8</td> <td>Unsigned</td> <td>Initial Sequence number</td> </tr>

<tr> <td>8</td> <td>Timestamp</td> <td>Initial timestamp</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Authenticator preference list
("MD5")</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Public key preference list
("nistp224")</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Encryptor preference list
("AES-CBC")</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Compressor preference list
("null")</td> </tr>

<tr> <td>28</td> <td>nistp224</td> <td>Client session public key</td> </tr>

<tr> <td>16</td> <td>MD5</td> <td>Authenticator</td> </tr>

</table>

<h2>CID: Initialization Response Packet</h2>

<table cellspacing="0" border="1" cellpadding="3">

<tr> <th>Size</th> <th>Type</th> <th>Description</th> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Packet type "SRL2"</td> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Message type "CID1"</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Authenticator choice</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Public key choice</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Encryptor choice</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Compressor choice</td> </tr>

<tr> <td>1+N</td> <td>String</td> <td>Extra parameters</td> </tr>

<tr> <td>28</td> <td>nistp224</td> <td>Server session public key</td> </tr>

<tr> <td>16</td> <td>MD5</td> <td>Authenticator</td> </tr>

</table>

<h2>MSG: Message Packet</h2>

<table cellspacing="0" border="1" cellpadding="3">

<tr> <th>Size</th> <th>Type</th> <th>Description</th> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Packet type "SRL2"</td> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Message type "MSGs"</td> </tr>

<tr> <td>8</td> <td>Unsigned</td> <td>Initial sequence number</td> </tr>

<tr> <td>1</td> <td>Unsigned</td> <td>Message count M</td> </tr>

<tr> <td>?</td> <td>Char</td> <td>Padding to fill out encryption block
size</td> <td></td> <td rowspan=4>Encrypted</td> </tr>

<tr> <td>8</td> <td>Timestamp</td> <td>Timestamp</td> <td colspan="1"
align="center" rowspan="2">Repeated M times</td> </tr>

<tr> <td>2+N</td> <td>String</td> <td>Line</td> </tr>

<tr> <td>4</td> <td>CRC-32</td> <td>Check code on encrypted data</td>
</tr>

<tr> <td>16</td> <td>MD5</td> <td>Authenticator</td> </tr>

</table>

<p>Notes: <ul>

<li>The sequence number and message count are explicitly <i>not</i> in
the encrypted section, since an attacker can trivially determine them
from the returning ACK packets.

<li>The length of the padding is at least one byte, and at most the
encryption block size.

<li> A check code (CRC-32) is included inside the encrypted data on MSG
packets to ensure that the encryption state is properly synchronized on
client and server.</li>

</ul></p>

<h2>ACK: Message Acknowledgement Packet</h2>

<table cellspacing="0" border="1" cellpadding="3">

<tr> <th>Size</th> <th>Type</th> <th>Description</th> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Packet type "SRL2"</td> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Message type "ACKn"</td> </tr>

<tr> <td>8</td> <td>Unsigned</td> <td>Sequence number</td> </tr>

<tr> <td>16</td> <td>MD5</td> <td>Authenticator</td> </tr>

</table>

<p>Notes: <ul>

<li>The sequence number in the ACK packet is the computed sequence
number of the last line in the MSG packet it is a response to.

</ul></p>

<h2>SRQ: Status Request</h2>

<table cellspacing="0" border="1" cellpadding="3">

<tr> <th>Size</th> <th>Type</th> <th>Description</th> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Packet type "SRL2"</td> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Message type "StRq"</td> </tr>

</table>

<h2>SRP: Status Response</h2>

<table cellspacing="0" border="1" cellpadding="3">

<tr> <th>Size</th> <th>Type</th> <th>Description</th> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Packet type "SRL2"</td> </tr>

<tr> <td>4</td> <td>Constant</td> <td>Message type "StRp"</td> </tr>

<tr> <td>2+N</td> <td>String</td> <td>Text status paragraph</td> </tr>

<tr> <td>16</td> <td>MD5</td> <td>Authenticator</td> </tr>

</table>
